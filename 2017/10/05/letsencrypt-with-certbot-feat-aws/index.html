<!DOCTYPE html>
<html lang="ko">
<head>    <meta charset="utf-8">
    
    <title>(Certbot) 공짜로 HTTPS 서버를 열어보자. (feat. AWS) | 오늘도 끄적끄적</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="robots" content="index,follow">
    

    <link rel="canonical" href="http://perfectacle.github.io/2017/10/05/letsencrypt-with-certbot-feat-aws/">
    <meta name="description" content="기본적으로 서버와 도메인(SSL 인증서에 넣을)은 확보가 돼있는 상태로 진행을 해야한다.자본이 빵빵하고(?) 좀 더 간단한 걸 원한다면 AWS ELB로 HTTPS 서버 열기를 보자.해당 포스트는 ELB 말고 인스턴스에 직접 도메인을 달고, 인스턴스에서 직접 HTTPS 서버를 서비스 하고자 하는 포스트이다. HTTPSHTTP 통신은 데이터를 암호화하지 않아">
<meta name="keywords" content="HTTPS,AWS,EC2,Route53,Nginx,LetsEncrypt,Certbot">
<meta property="og:type" content="article">
<meta property="og:title" content="(Certbot) 공짜로 HTTPS 서버를 열어보자. (feat. AWS)">
<meta property="og:url" content="http://perfectacle.github.io/2017/10/05/letsencrypt-with-certbot-feat-aws/index.html">
<meta property="og:site_name" content="오늘도 끄적끄적">
<meta property="og:description" content="기본적으로 서버와 도메인(SSL 인증서에 넣을)은 확보가 돼있는 상태로 진행을 해야한다.자본이 빵빵하고(?) 좀 더 간단한 걸 원한다면 AWS ELB로 HTTPS 서버 열기를 보자.해당 포스트는 ELB 말고 인스턴스에 직접 도메인을 달고, 인스턴스에서 직접 HTTPS 서버를 서비스 하고자 하는 포스트이다. HTTPSHTTP 통신은 데이터를 암호화하지 않아">
<meta property="og:locale" content="ko">
<meta property="og:image" content="http://perfectacle.github.io/2017/10/05/letsencrypt-with-certbot-feat-aws/thumb.png">
<meta property="og:updated_time" content="2017-10-07T11:00:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="(Certbot) 공짜로 HTTPS 서버를 열어보자. (feat. AWS)">
<meta name="twitter:description" content="기본적으로 서버와 도메인(SSL 인증서에 넣을)은 확보가 돼있는 상태로 진행을 해야한다.자본이 빵빵하고(?) 좀 더 간단한 걸 원한다면 AWS ELB로 HTTPS 서버 열기를 보자.해당 포스트는 ELB 말고 인스턴스에 직접 도메인을 달고, 인스턴스에서 직접 HTTPS 서버를 서비스 하고자 하는 포스트이다. HTTPSHTTP 통신은 데이터를 암호화하지 않아">
<meta name="twitter:image" content="http://perfectacle.github.io/2017/10/05/letsencrypt-with-certbot-feat-aws/thumb.png">
    
    

    
        <link rel="alternate" href="/atom.xml" title="오늘도 끄적끄적" type="application/atom+xml">
    

    
        <link rel="icon" href="/css/images/favicon.png">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-87795455-1', 'auto');
ga('send', 'pageview');

</script>
    
    


    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-3881550906962162",
        enable_page_level_ads: true
      });
    </script>
</head>
<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/">
                            <img src="/css/images/logo.png" class="logo" alt="로고"><br>
                            <span class="txt-title">오늘도 끄적끄적</span>
                        </a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                            <li class="main-nav-list-item">
                                <a class="main-nav-list-link" href="/">Home</a>
                            </li>
                            
                            <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Back-end/">Back-end</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Back-end/Spring/">Spring</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Back-end/Spring-Boot/">Spring Boot</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Front-end/">Front-end</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Front-end/Babel/">Babel</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Front-end/React/">React</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Front-end/Webpack/">Webpack</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Middle-end/">Middle-end</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Middle-end/DevOps/">DevOps</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Middle-end/Pattern/">Pattern</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Middle-end/git/">git</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Middle-end/자료구조/">자료구조</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Note/">Note</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Note/Dev/">Dev</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Note/Java/">Java</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Note/Spring-Boot/">Spring Boot</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/">Programming</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/ASM/">ASM</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/C-C/">C/C++</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/ECMAScript/">ECMAScript</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Node-js/">Node.js</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/기타/">기타</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/기타/등등/">등등</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/기타/음악/">음악</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/기타/자작/">자작</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/기타/잡동사니/">잡동사니</a></li></ul></li></ul>
                            
                            <li class="main-nav-list-item">
                                <a class="main-nav-list-link" href="/about/index.html">About</a>
                            </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="검색">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="검색어를 입력하세요...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '포스트',
            PAGES: 'Pages',
            CATEGORIES: '카테고리',
            TAGS: '태그',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                
                
                <section id="main">
                    <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Middle-end/">Middle-end</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/Middle-end/DevOps/">DevOps</a>
    </h1>
</div>
                    <div class="main-body-content">
                        <article id="post-letsencrypt-with-certbot-feat-aws" class="article article-single article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        (Certbot) 공짜로 HTTPS 서버를 열어보자. (feat. AWS)
        </h1>
    

            </header>
            
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2017/10/05/letsencrypt-with-certbot-feat-aws/" class="article-date">
            <time datetime="2017-10-05T06:47:46.000Z" itemprop="datePublished">2017-10-05</time>
        </a>
    </div>

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/AWS/">AWS</a>, <a class="tag-link" href="/tags/Certbot/">Certbot</a>, <a class="tag-link" href="/tags/EC2/">EC2</a>, <a class="tag-link" href="/tags/HTTPS/">HTTPS</a>, <a class="tag-link" href="/tags/LetsEncrypt/">LetsEncrypt</a>, <a class="tag-link" href="/tags/Nginx/">Nginx</a>, <a class="tag-link" href="/tags/Route53/">Route53</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p><img src="thumb.png" alt="귀염둥이 Certbot"></p>
<p>기본적으로 서버와 도메인(SSL 인증서에 넣을)은 확보가 돼있는 상태로 진행을 해야한다.<br>자본이 빵빵하고(?) 좀 더 간단한 걸 원한다면 <a href="/2017/10/05/https-with-elb/">AWS ELB로 HTTPS 서버 열기</a>를 보자.<br>해당 포스트는 ELB 말고 인스턴스에 직접 도메인을 달고, 인스턴스에서 직접 HTTPS 서버를 서비스 하고자 하는 포스트이다.</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>HTTP 통신은 데이터를 암호화하지 않아서 보안에 취약하다.<br>따라서 HTTPS 프로토콜로 통신을 해야하는데 암/복호화를 하려면 키가 존재해야하고,<br>그 키는 인증된 기관에서 만든 게 아니면 신뢰할 수 없는 키가 된다.<br>이 키에 대한 정보가 SSL 인증서에 들어가있는 것이고 이 SSL 인증서를 발급해주는 기관들이 따로 있다.<br>(사실 SSL의 이름은 TLS로 바뀌었지만 계속해서 SSL로 쓰이는 듯…)<br>그런데 그 인증서를 발급해주는 기관에서는 돈을 받고 SSL 인증서를 발급해주고 일정 기간마다 돈을 추가로 내서 갱신해야한다.  </p>
<h2 id="공짜-SSL-인증서-발급기관"><a href="#공짜-SSL-인증서-발급기관" class="headerlink" title="공짜 SSL 인증서 발급기관"></a>공짜 SSL 인증서 발급기관</h2><p><a href="https://letsencrypt.org/" rel="external nofollow noopener noreferrer" target="_blank">Let’s Encrypt</a>라는 사이트에서 공짜로 SSL 인증서를 발급해준다.<br>과거에는 어떻게 했는지 모르겠지만 지금은 <a href="https://certbot.eff.org/" rel="external nofollow noopener noreferrer" target="_blank">Certbot</a>이라는 프로그램을 통해서<br>Let’s Encrypt의 SSL 인증서를 발급받을 수 있다.<br>또한 Let’s Encrypt는 90일 동안만 유효한 SSL 인증서를 발급해주는데 Certbot을 이용하면 갱신이 매우 쉬워진다.  </p>
<h2 id="Route-53-도메인-설정하기"><a href="#Route-53-도메인-설정하기" class="headerlink" title="Route 53(도메인) 설정하기"></a>Route 53(도메인) 설정하기</h2><p>기본적으로 도메인을 확보한 이후에 또 해야하는 게 있다.<br>바로 해당 도메인에 대한 CAA(Certificate Authority Authorization) Record를 추가해야한다.<br><a href="https://sslmate.com/caa/" rel="external nofollow noopener noreferrer" target="_blank">SSLMate’s CAA Record Generator</a>에 들어가면 만들 수 있다지만 들어가봐도 네트워크 지식이 없다보니 그냥 아래 스샷과 같이 만들었다.<br><img src="route53.png" alt="SSL 인증서 발급을 위한 CAA Record"><br>name에는 당연히 발급을 위한 도메인이 들어가야한다.</p>
<h2 id="Certbot"><a href="#Certbot" class="headerlink" title="Certbot"></a>Certbot</h2><p><a href="https://certbot.eff.org/" rel="external nofollow noopener noreferrer" target="_blank">Certbot</a> 사이트에 들어가면 어떻게 설치하는지 나오지만 나도 헷갈려서 직접 정리해보았다.<br><strong>이 포스트에서는 OS는 Amazon Linux AMI와 웹서버는 nginx를 사용하였다.</strong></p>
<p>혹시 커맨드를 입력했을 때 권한이 없다고 하면 귀찮으니까 root 유저로 진행하자.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo su</div></pre></td></tr></table></figure></p>
<p>SSL 인증서를 발급받기 전에 nginx와 같은 웹서버는 무조건 중단해야한다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service nginx stop</div></pre></td></tr></table></figure></p>
<p>이제 아래 커맨드를 입력해서 certbot 설치를 하자.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -O https://dl.eff.org/certbot-auto</div><div class="line">chmod +x certbot-auto</div><div class="line">mv certbot-auto /usr/bin/certbot-auto</div></pre></td></tr></table></figure></p>
<p>그리고 실제 SSL 인증서를 발급받아보도록 하자.<br>현재 AWS Linux는 아직 정식 지원이 아닌지 –debug를 붙여줘야한다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">certbot-auto certonly --standalone -d 발급받을도메인</div><div class="line"></div><div class="line"><span class="comment"># 위 과정에서 이메일을 물어볼 수도 있다.</span></div><div class="line"><span class="comment"># 아래와 같은 메시지가 나온다면 발급에 성공한 것이다.</span></div><div class="line"><span class="comment"># IMPORTANT NOTES:</span></div><div class="line"><span class="comment">#  - Congratulations! Your certificate and chain have been saved at</span></div><div class="line"><span class="comment">#    /etc/letsencrypt/live/example.com/fullchain.pem. Your cert will</span></div><div class="line"><span class="comment">#    expire on 2018-mm-dd. To obtain a new version of the certificate in</span></div><div class="line"><span class="comment">#    the future, simply run Certbot again.</span></div><div class="line"><span class="comment">#  - If you like Certbot, please consider supporting our work by:</span></div><div class="line"><span class="comment"># </span></div><div class="line"><span class="comment">#    Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate</span></div><div class="line"><span class="comment">#    Donating to EFF:                    https://eff.org/donate-le</span></div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">There were too many requests of a given type :: Error creating new authz :: Too many invalid authorizations recently.</div><div class="line">Please see the logfiles in /var/log/letsencrypt for more details.</div></pre></td></tr></table></figure>
<p>위와 같은 오류를 만났다면 단시간 내에 SSL 발급 요청을 너무 많이 했는데 모두<br>유효하지 않은 요청이라 악의적이라 판단해서 해당 도메인에 대해 발급 요청이 일시 중단된 상태이다.<br>1시간 가량 기다린 후에 진행하면 다시 되는 것 같다.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-- The following errors were reported by the server:</div><div class="line">Domain: &lt;my_domain&gt;</div><div class="line">Type: connection</div><div class="line">Detail: CAA record for &lt;my_domain&gt; prevents issuance</div></pre></td></tr></table></figure>
<p>위와 같은 오류는 도메인에 CAA record가 제대로 등록되지 않았다는 것이다.<br>도메인명과 CAA 레코드에 제대로 된 값들이 들어갔는지 다시 확인해보자.  </p>
<h2 id="적용하기"><a href="#적용하기" class="headerlink" title="적용하기"></a>적용하기</h2><p>nginx 서버에서 다음와 같이 설정을 해주어야한다.<br>기본적인 설정 파일은 /etc/nginx/conf.d/virtual.conf에 있다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  ~.;</div><div class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>80번 포트로 들어오면 다시 https로 리다이렉트 시키는 부분이다.<br>301 redirect는 영구적으로 옮겼을 때 사용한다.  </p>
<p>그리고 아래 부분에는 HTTPS 서버를 리스닝 하는 부분을 추가해주자.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    server_name  ~.;</div><div class="line">    listen 443;</div><div class="line">    </div><div class="line">    ssl                  on;</div><div class="line">    ssl_certificate      /etc/letsencrypt/live/도메인/fullchain.pem;</div><div class="line">    ssl_certificate_key  /etc/letsencrypt/live/도메인/privkey.pem;</div><div class="line">    ssl_session_cache shared:SSL:1m;</div><div class="line">    ssl_session_timeout  10m;</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP;</div><div class="line">    ssl_prefer_server_ciphers   on;</div><div class="line"></div><div class="line">    <span class="comment"># 특정 포트로 다시 보내고 싶을 때</span></div><div class="line">    <span class="comment"># location / &#123;</span></div><div class="line">    <span class="comment">#     proxy_set_header X-Real-IP $remote_addr;</span></div><div class="line">    <span class="comment">#     proxy_set_header HOST $http_host;</span></div><div class="line">    <span class="comment">#     proxy_set_header X-NginX-Proxy true;</span></div><div class="line">    <span class="comment">#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></div><div class="line"> </div><div class="line">    <span class="comment">#     proxy_pass http://127.0.0.1:8080;</span></div><div class="line">    <span class="comment">#     proxy_redirect off;</span></div><div class="line">    <span class="comment"># &#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>도메인 부분에 SSL 인증서를 발급받은 도메인을 입력하면 된다.<br>그리고 실제 톰캣과 같은 WAS나 서버가 띄워져있는 포트로 보내려면 주석을 지우고 포트를 바꿔주면 된다.<br>그리고 아래와 같이 nginx 서버를 재구동 하고 브라우저에서 도메인을 입력하고 http to https와 ssl 인증서가 제대로 적용됐는지 확인해보자.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">service nginx start</div><div class="line"><span class="comment"># 혹시 재시작이 안 됐다면 아래 커맨드를 입력하자.</span></div><div class="line">/etc/init.d/nginx restart</div></pre></td></tr></table></figure></p>
<h2 id="자동-갱신하기"><a href="#자동-갱신하기" class="headerlink" title="자동 갱신하기"></a>자동 갱신하기</h2><p>Certbot으로 발급 받았다 하더라도 Let’s Encrypt의 SSL 인증서를 발급받은 것이기 때문에 유효기간은 90일이다.<br>따라서 수동으로 갱신할 때 명령어는 다음과 같다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">certbot-auto renew</div></pre></td></tr></table></figure></p>
<p>하지만 갱신일이 30일 이상 남은 경우에는 아래와 같은 오류를 보게될 것이다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cert not yet due for renewal</div></pre></td></tr></table></figure></p>
<p>따라서 테스트를 위해서는 –dry-run 옵션을 추가해야한다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">certbot-auto renew --dry-run</div></pre></td></tr></table></figure></p>
<p>하지만 이번에는 아래와 같은 오류가 나게 된다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">produced an unexpected error: Problem binding to port 443: Could not bind to IPv4 or IPv6.. Skipping.</div><div class="line">All renewal attempts failed. The following certs could not be renewed</div></pre></td></tr></table></figure></p>
<p>갱신하려는 인증서를 이미 nginx 서버에서 사용중이기 때문에 갱신이 불가능하다는 내용이다.<br>따라서 nginx를 스탑하고 갱신하고 다시 start 해야하는데 귀찮으므로 hook 옵션을 제공해서 아래와 같이 사용하면 된다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">certbot-auto renew --pre-hook <span class="string">"service nginx stop"</span> --post-hook <span class="string">"service nginx start"</span> --dry-run</div></pre></td></tr></table></figure>
<p>드디어 아래와 같은 성공 메시지를 보게 될 것이다.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Congratulations, all renewals succeeded. The following certs have been renewed:</div></pre></td></tr></table></figure></p>
<p>하지만 아직 테스트 단계이므로 실제로 갱신이 이루어지지는 않는다.<br>갱신일이 궁금하다면 아래 커맨드를 입력하면 된다.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> | openssl s_client -connect localhost:443 2&gt;/dev/null | openssl x509 -noout -dates</div></pre></td></tr></table></figure></p>
<p>30일 남았는지 일일이 체크해서 갱신하기란 매우 귀찮다.<br>따라서 매달 1일에 갱신하는 커맨드를 실행하게 끔 crontab을 사용하자.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 잡을 등록</span></div><div class="line">crontab -e</div><div class="line"></div><div class="line"><span class="comment"># 그리고 아래 잡을 추가하고 저장하자.</span></div><div class="line">0 0 1 * * certbot-auto renew --pre-hook <span class="string">"service nginx stop"</span> --post-hook <span class="string">"service nginx start"</span></div><div class="line"></div><div class="line"><span class="comment"># 등록된 잡 목록 보기</span></div><div class="line">crontab -l</div></pre></td></tr></table></figure></p>
<p>crontab 규칙은 <a href="https://crontab.guru/" rel="external nofollow noopener noreferrer" target="_blank">crontab.guru</a>에서 확인할 수 있고, 직접 만들거나 결과를 예측해볼 수도 있다.  </p>
<h2 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h2><p>끝이다.<br>아직 나도 갱신일이 30일 넘게 남아서(사실 오늘 만들어봤지만…) 테스트를 해보지 않았다.<br>나중에 시간이 지나면 잘 되는지 보고 다시 수정해봐야겠다.<br>이 과정이 좀 어렵고 자본이 빵빵하다면(?) <a href="/2017/10/05/https-with-elb/">AWS ELB로 HTTPS 서버 열기</a>를 보자.</p>

        </div>
        
        <footer class="article-footer">
            



    <a data-url="http://perfectacle.github.io/2017/10/05/letsencrypt-with-certbot-feat-aws/" data-id="cj8h7shua009lten9x3570be2" class="article-share-link"><i class="fa fa-share"></i>공유하기</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
        
    </div>
</article>


    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                    </div>
                </section>
                
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <p>&copy; 2017 양권성</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'exobud';
    
    
    var disqus_url = 'http://perfectacle.github.io/2017/10/05/letsencrypt-with-certbot-feat-aws/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
